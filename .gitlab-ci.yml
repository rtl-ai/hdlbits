stages:
  - filelist
  - compile
  - elaborate
  - synth
  - test
  - report
  - secret-detection

variables:
  PYTHONUNBUFFERED: "1"
  SECRET_DETECTION_ENABLED: "true"

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

generate:filelist:
  stage: filelist
  image: python:3.11-slim
  script:
    - python3 scripts/generate_filelists.py
  artifacts:
    paths:
      - listfile/rtl.f
    expire_in: 1 week

compile:iverilog:
  stage: compile
  image: hdlc/iverilog:latest
  needs: ["generate:filelist"]
  script:
    - ./scripts/run_iverilog_checks.sh listfile/rtl.f compile
  artifacts:
    when: always
    paths:
      - build/reports
      - build/metrics
    reports:
      metrics:
        - build/metrics/compile_metrics.json
    expire_in: 1 week

elaborate:iverilog:
  stage: elaborate
  image: hdlc/iverilog:latest
  needs: ["generate:filelist"]
  script:
    - ./scripts/run_iverilog_checks.sh listfile/rtl.f elaborate
  artifacts:
    paths:
      - build/elab
      - build/reports
      - build/metrics
    expire_in: 1 week
    when: always
    reports:
      metrics:
        - build/metrics/elaborate_metrics.json

synth:yosys:
  stage: synth
  image: debian:bookworm-slim
  needs: ["generate:filelist"]
  before_script:
    - apt-get update
    - DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends yosys
    - apt-get clean
    - rm -rf /var/lib/apt/lists/*
  script:
    - ./scripts/run_yosys_synth.sh listfile/rtl.f
  artifacts:
    paths:
      - build/synth
      - build/reports
      - build/metrics
    expire_in: 1 week
    when: always
    reports:
      metrics:
        - build/metrics/synth_metrics.json

unit:test:
  stage: test
  image: python:3.11-slim
  before_script:
    - pip install --no-cache-dir pytest pytest-cov
  script:
    - mkdir -p build/reports build/metrics
    - set +e
    - pytest --cov=tools --cov-report=term --cov-report=xml --cov-fail-under=100 --junitxml build/reports/pytest-junit.xml
    - test_rc=$?
    - set -e
    - python3 -m tools.metrics pytest --junit build/reports/pytest-junit.xml --stage test --output build/metrics/test_metrics.json
    - exit $test_rc
  artifacts:
    when: always
    paths:
      - coverage.xml
      - .coverage
      - build/reports
      - build/metrics
    reports:
      metrics:
        - build/metrics/test_metrics.json
  needs: []

metrics:summary:
  stage: report
  image: python:3.11-slim
  needs:
    - job: compile:iverilog
      artifacts: true
    - job: elaborate:iverilog
      artifacts: true
    - job: synth:yosys
      artifacts: true
    - job: unit:test
      artifacts: true
  script:
    - mkdir -p build/metrics
    - python3 -m tools.metrics summary --inputs build/metrics/compile_metrics.json build/metrics/elaborate_metrics.json build/metrics/synth_metrics.json build/metrics/test_metrics.json --output build/metrics/summary.md --post-comment
    - if [ -n "${CI_JOB_SUMMARY:-}" ]; then cat build/metrics/summary.md >> "${CI_JOB_SUMMARY}"; fi
  artifacts:
    when: always
    paths:
      - build/metrics/summary.md
